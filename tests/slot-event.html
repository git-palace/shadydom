<!doctype html>
<!--
@license
Copyright (c) 2017 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>

<head>
  <meta charset="utf-8">

  <script src="../../webcomponents-platform/webcomponents-platform.js"></script>
  <script src="../../template/template.js"></script>
  <script>
    ShadyDOM = { force: true };
    if (window.customElements) {
      // customElements.forcePolyfill = true;
    }
  </script>
  <script src="../shadydom.min.js"></script>
  <script src="../../custom-elements/custom-elements.min.js"></script>
  <script>
    // Ensure customElements are updated when document is ready.
    if (customElements.polyfillWrapFlushCallback) {
      customElements.polyfillWrapFlushCallback(function (cb) {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', cb);
        } else {
          cb();
        }
      });
    }
  </script>

  <script src="../../web-component-tester/browser.js"></script>
</head>
<body>
  <template id="inner">
    <slot></slot>
  </template>

  <template id="outer">
    <x-inner><slot></slot></x-inner>
  </template>

  <template id="failure">
    <x-outer><div></div></x-outer>
  </template>

  <script>
    suite('Slot distribution and events', function() {
      test('slot distribution is not interrupted by events', function(done) {
        let innerTemplate = document.querySelector('template#inner');
        let outerTemplate = document.querySelector('template#outer');
        let failureTemplate = document.querySelector('template#failure');

        class XInner extends HTMLElement {
          connectedCallback() {
            if (!this.shadowRoot) {
              this.attachShadow({mode: 'open'});
              this.shadowRoot.appendChild(document.importNode(innerTemplate.content, true));
              this.dispatchEvent(new Event('test', {bubbles: true, composed: true}));
            }
          }
        }

        class XOuter extends HTMLElement {
          connectedCallback() {
            if (!this.shadowRoot) {
              this.attachShadow({mode: 'open'});
              this.shadowRoot.appendChild(document.importNode(outerTemplate.content, true));
            }
          }
        }

        customElements.define('x-inner', XInner);
        customElements.define('x-outer', XOuter);

        assert.doesNotThrow(() => {
          document.body.appendChild(document.importNode(failureTemplate.content, true));
          ShadyDOM.flush();
          done();
        });
      })
    })
  </script>
</body>